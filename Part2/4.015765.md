#### ISO15765在下载工具代码当中的实现

* ##### 前言

在我的理解当中,ISO15765有三个功能：  
（1）为应用层提供服务：Request、Confirm、Indication

（2）为上层提供接口实现数据交流：分段、重组与流控制

（3）网络层中的时间控制：STmin、N\_As等  
这三个部分构成了网络层协议的整体，从而为对等实体间的CAN通信提供了基础，

###### （1）服务原语

SocketCAN提供了一个非常好的通信接口：  
`write(s, &frame, sizeof(frame));`的返回值是发送的字节，如果不为0，则发送成功（Confirm服务与Request服务）  
`read(s, &frame, sizeof(frame));`的返回值是接收的字节，如果不为0，接收成功（Indication服务）

###### （2）数据流控制

在网络层中定义了初始化FF与CF的函数

```c
void Frame_Init_FF(struct can_frame* frame,uint32_t byte_send)
{
        frame->can_id=FF_ID;
        frame->can_dlc=8;
        frame->data[0]=0xf&(byte_send>>8);
        frame->data[0]|=0x10;
        frame->data[1]=0xff&byte_send;
}
void Frame_Init_CF(struct can_frame* Frame,int Frame_Count){
    for(int i=0;i<Frame_Count;i++)
    {
        Frame[i].can_id = FF_ID;
        Frame[i].data[0] = GLOBAL_SN;
        Frame[i].can_dlc = 8;
        GLOBAL_SN++;
        if (GLOBAL_SN > 0x2F)
            GLOBAL_SN=0x20;
    }
}
```



